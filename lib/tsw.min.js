"use strict";
let tsw_ajax_url;
let tsw_interval_id;
let tsw_status = 'stopped';
let tsw_datatables;
window.addEventListener('load', function() {
    console.log('Loading The SEO Workspace view..');
    if (typeof weAreInTheSeoWorkspace !== 'undefined') {
        tsw_ajax_url = document.getElementById('tsw_form').dataset.tsw_ajax_url;
    }
    jQuery('body').on('click', '.tsw-wrap a[href="#"]', function (e) {
        e.preventDefault();
    });
    jQuery('body').on('click', '.tsw-btn-see-results', function () {
        let newTab = window.open('/wp-admin/tools.php?page=the-seo-machine', '_blank');
    });
    jQuery('body').on('click', '.tsw-btn-study-site', function () {
        if (tsw_status == 'stopped') {
            tswStudySite();
        } else {
            tswStopAll();
        }
    });
    tswLoadDatatables();
    tswUpdateStatusBar();
});
function tswStudySite() {
    console.log('Starting study site..');
    document.getElementById('tsw-btn-study-site').innerHTML = 'Stop';
    document.getElementById('tsw-btn-study-site').classList.add('tsw-button-studying');
    let quantity_per_batch = document.getElementById('quantity_per_batch').value;
    let time_between_batches = document.getElementById('time_between_batches').value;
    console.log('Quantity per batch: ' + quantity_per_batch + ', time between batches: ' + time_between_batches);
    tsw_interval_id = setInterval(tswStudySiteSendAjax, time_between_batches * 1000);
    tsw_status = 'studying';
}
function tswStudySiteSendAjax() {
    document.getElementById('tsw-box-study-site-status').innerHTML = 'Doing batch..';
    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function (response) {
        if (xhr.readyState === 4) {
            document.getElementById('tsw-box-study-site-status').innerHTML = 'Studying with current status: <strong>' + xhr.responseText + '</strong>';
            tswUpdateStatusBar();
            if (xhr.responseText.includes('finished')) {
                tswStopAll();
            }
        }
    }
    xhr.open('POST', tsw_ajax_url);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
    xhr.send('action=tsw_do_batch&site-id=' + document.getElementById('tsw-current-selected-site-id').value);
}
function tswUpdateStatusBar() {
    if(document.getElementById('tsw-current-selected-site-id')) {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function (response) {
            if (xhr.readyState === 4) {
                let num_urls_in_queue = xhr.responseText.split(',')[0];
                let num_urls_in_queue_visited = xhr.responseText.split(',')[1];
                let num_urls = xhr.responseText.split(',')[2];
                document.getElementById('tsw-progress-queue-text').innerHTML = num_urls_in_queue_visited
                    + ' URLs studied from the queue out of a total of ' + num_urls_in_queue + ' URLs enqueued';
                document.getElementById('tsw-progress-queue-content').style.width = (num_urls_in_queue_visited * 100 / num_urls_in_queue) + '%';
            }
        }
        xhr.open('POST', tsw_ajax_url);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
        xhr.send('action=tsw_get_status&site-id=' + document.getElementById('tsw-current-selected-site-id').value);
    }
}
function tswStopAll() {
    clearInterval(tsw_interval_id);
    document.getElementById('tsw-btn-study-site').innerHTML = 'Study Site';
    document.getElementById('tsw-btn-study-site').classList.remove('tsw-button-studying');
    tsw_status = 'stopped';
}
function tswLoadDatatables() {
    jQuery('#tsw-datatable tfoot th.filterme').each(function () {
        let title = jQuery(this).text();
        jQuery(this).html('<input type="text" placeholder="Filter.." />');
    })
    tsw_datatables = jQuery('#tsw-datatable').DataTable({
        dom: '<"float-left"i><"float-right"f>t<"float-left"l>B<"float-right"p><"clearfix">',
        responsive: true,
        order: [[0, "desc"]],
        buttons: ['csv', 'excel', 'pdf'],
        initComplete: function () {
            this.api().columns().every(function () {
                let that = this
                jQuery('input', this.footer()).on('keyup change', function () {
                    if (that.search() !== this.value) {
                        that
                            .search(this.value)
                            .draw()
                    }
                })
            })
        },
        processing: true,
        serverSide: true,
        ajax: {
            url: tsw_ajax_url + '?action=tsw_urls',
            type: 'POST'
        },
        columnDefs: [
            { 'name': 'id', 'targets': 0 },
            { 'name': 'home_url', 'targets': 1 },
            { 'name': 'mainInfo', 'targets': 2 },
            { 'name': 'is_online', 'targets': 3 },
            { 'name': 'emails_to_notify', 'targets': 4 },
            {
                'name': 'actions',
                'targets': 5,
                'data': null,
                'defaultContent': 'Show Edit',
                'render': function (data, type, row, meta) {
                    return '<a href="?page=the-seo-workspace&select-id=' + data[0] + '" class="button button-green tsw-btn-select-item">Select</a>' +
                        '<a href="?page=the-seo-workspace&edit-id=' + data[0] + '" class="button button-green tsw-btn-edit-item">Edit</a>';
                }
            }
        ],
        aLengthMenu: [[10, 25, 50, 100, 500, 1000, 2000, 5000, 10000, -1], [10, 25, 50, 100, 500, 1000, 2000, 5000, 10000, "All"]]
    });
    console.log('Loaded The SEO Workspace view!');
}
